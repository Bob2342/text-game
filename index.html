<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI Text Adventure (Groq Streaming + Free Actions)</title>

<style>
    body {
        margin: 0;
        background: #0e0e0f;
        font-family: "Segoe UI", sans-serif;
        color: #e6e6e6;
        display: flex;
        justify-content: center;
        padding: 30px;
    }

    #container {
        width: 900px;
        display: flex;
        gap: 20px;
    }

    /* Sidebar */
    #sidebar {
        width: 250px;
        background: #1a1a1d;
        padding: 20px;
        border-radius: 12px;
        height: fit-content;
        box-shadow: 0 0 10px #0006;
    }

    #inventoryBox {
        margin-top: 20px;
        border: 1px solid #333;
        padding: 10px;
        border-radius: 8px;
        min-height: 80px;
    }

    /* Game panel */
    #gameBox {
        flex: 1;
        background: #1f1f23;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 0 10px #0008;
        display: none;
        animation: fadeIn .5s ease;
        position: relative;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    #questionText {
        font-size: 1.3em;
        padding-bottom: 15px;
        white-space: pre-wrap;
    }

    #playerInput {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        background: #2b2b30;
        border: 1px solid #444;
        color: white;
        margin-top: 10px;
        margin-bottom: 10px;
    }

    #actionBtn {
        padding: 12px;
        background: #3a3af1;
        border: none;
        border-radius: 6px;
        color: white;
        cursor: pointer;
        width: 100%;
        font-size: 1em;
    }

    #actionBtn:hover {
        background: #5656ff;
    }

    #skipBtn {
        display:none;
        position:absolute;
        top:20px;
        right:20px;
        padding:10px 15px;
        background:#ff4444;
        border:none;
        color:white;
        border-radius:6px;
        cursor:pointer;
        z-index:10;
    }
</style>
</head>
<body>

<div id="container">

    <!-- Sidebar -->
    <div id="sidebar">
        <h3>Game Settings</h3>

        <label>Groq API Key:</label>
        <input id="apiKey" type="password" style="width:100%; padding:6px; margin-top:5px; background:#2d2d31; border:1px solid #444; color:white; border-radius:6px;">

        <label style="margin-top:15px;">Game Instructions:</label>
        <textarea id="preInstructions" rows="6" style="width:100%; background:#2d2d31; border:1px solid #444; color:white; padding:6px; border-radius:6px;">You are a text adventure generator.
Output ONLY the next scenario question.
No explanations, no lists, no formatting.</textarea>

        <button class="smallBtn" onclick="startGame()">Start Game</button>
        <button class="smallBtn" onclick="saveGame()">Save Game</button>
        <button class="smallBtn" onclick="loadGame()">Load Game</button>

        <h3 style="margin-top:25px;">Inventory</h3>
        <div id="inventoryBox">Empty…</div>
    </div>

    <!-- Game -->
    <div id="gameBox">
        <button id="skipBtn">Skip</button>

        <div id="questionText">Loading…</div>

        <input id="playerInput" placeholder="Type your action...">
        <button id="actionBtn" onclick="submitAction()">Submit Action</button>

        <div id="errorText" style="color:#ff4444; margin-top:10px;"></div>
    </div>

</div>

<script>
/* ======================================
   GLOBALS
====================================== */
let skipRequested = false;
let skipButtonTimeout = null;
let apiKey = "";
let history = [];
let inventory = [];

/* ======================================
   FORBIDDEN ACTION VALIDATOR
====================================== */
const forbiddenWords = [
    "fly", "fly away",
    "teleport", "tp",
    "spawn", "summon",
    "nuke", "explode",
    "kill everyone", "kill all",
    "hack", "glitch",
    "duplicate", "duplicate item"
];

function isForbiddenAction(text) {
    const lower = text.toLowerCase();

    return forbiddenWords.some(word => lower.includes(word));
}

/* ======================================
   SKIP BUTTON
====================================== */
document.getElementById("skipBtn").onclick = () => {
    skipRequested = true;
    document.getElementById("skipBtn").style.display = "none";
};

/* ======================================
   GROQ STREAMING FUNCTION
====================================== */
async function groqQuery(apiKey, messages, onChunk, onDone) {
    const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + apiKey,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            model: "openai/gpt-oss-120b",
            messages: messages,
            temperature: 1,
            max_completion_tokens: 300,
            stream: true
        })
    });

    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let fullText = "";

    skipRequested = false;
    clearTimeout(skipButtonTimeout);

    skipButtonTimeout = setTimeout(() => {
        if (!skipRequested) {
            document.getElementById("skipBtn").style.display = "block";
        }
    }, 3000);

    while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split("\n");

        for (const line of lines) {
            if (!line.startsWith("data:")) continue;
            const json = line.replace("data: ", "").trim();

            if (json === "[DONE]") continue;

            try {
                const parsed = JSON.parse(json);
                const delta = parsed.choices?.[0]?.delta?.content;

                if (delta) {
                    fullText += delta;

                    if (skipRequested) {
                        onChunk(fullText);
                    } else {
                        onChunk(fullText);
                        await new Promise(r => setTimeout(r, 10));
                    }
                }
            } catch {}
        }
    }

    clearTimeout(skipButtonTimeout);
    document.getElementById("skipBtn").style.display = "none";

    onDone(fullText);
    return fullText;
}

/* ======================================
   START GAME
====================================== */
async function startGame() {
    apiKey = document.getElementById("apiKey").value.trim();
    if (!apiKey) return alert("Enter API key.");

    const rules = document.getElementById("preInstructions").value;

    history = [
        { role: "system", content: rules }
    ];

    document.getElementById("gameBox").style.display = "block";
    document.getElementById("questionText").innerText = "Loading…";

    await groqQuery(
        apiKey,
        history,
        partial => (document.getElementById("questionText").innerText = partial),
        final => showQuestion(final)
    );
}

/* ======================================
   SHOW QUESTION
====================================== */
function showQuestion(q) {
    document.getElementById("questionText").innerText = q;
}

/* ======================================
   PLAYER ACTION
====================================== */
async function submitAction() {
    const pInput = document.getElementById("playerInput");
    const errorBox = document.getElementById("errorText");
    const action = pInput.value.trim();

    errorBox.innerText = "";

    if (!action) return;

    // Check forbidden actions
    if (isForbiddenAction(action)) {
        errorBox.innerText = "Sorry, you can’t do that.";
        return;
    }

    pInput.value = "";

    history.push({ role: "user", content: action });

    history.push({
        role: "system",
        content: "Reminder: only output the next scenario question."
    });

    document.getElementById("questionText").innerText = "";

    await groqQuery(
        apiKey,
        history,
        partial => (document.getElementById("questionText").innerText = partial),
        final => showQuestion(final)
    );
}

/* ======================================
   SAVE / LOAD
====================================== */
function saveGame() {
    localStorage.setItem("savedGame", JSON.stringify({ history, inventory }));
    alert("Game saved!");
}

function loadGame() {
    const data = localStorage.getItem("savedGame");
    if (!data) return alert("No saved game found.");

    const save = JSON.parse(data);
    history = save.history;
    inventory = save.inventory;

    const last = history.filter(m => m.role === "assistant").slice(-1)[0];
    if (!last) return alert("Save corrupted.");

    document.getElementById("gameBox").style.display = "block";
    showQuestion(last.content);
}
</script>

</body>
</html>
